<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ABT AI Image Desc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f8f9fa; padding-top: 0; }
        .container { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; align-items: flex-start; padding: 24px 8px; }
        .left, .right { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 20px; flex: 1 1 320px; min-width: 280px; max-width: 480px; }
        .left { display: flex; flex-direction: column; align-items: center; margin-bottom: 24px; }
        .left img { max-width: 100%; max-height: 320px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        .label-attrs { margin-top: 16px; width: 100%; }
        .label-attrs table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .label-attrs th, .label-attrs td { padding: 4px 8px; border-bottom: 1px solid #eee; text-align: left; }
        .label-attrs th { color: #007bff; font-weight: 600; }
        .preview-block { display: flex; flex-direction: column; align-items: center; margin-bottom: 24px; }
        .preview-block img { max-width: 100%; max-height: 320px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        .candidates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; }
        .candidate { border: 2px solid #ccc; border-radius: 8px; padding: 4px; text-align: center; cursor: pointer; transition: border 0.2s, box-shadow 0.2s, transform 0.18s; background: #fafbfc; }
        .candidate.selected { border: 2px solid #007bff; box-shadow: 0 2px 8px rgba(0,123,255,0.08); }
        .candidate img { max-width: 100%; max-height: 100px; border-radius: 6px; transition: transform 0.18s; }
        .candidate:hover img { transform: scale(1.15); z-index: 2; }
        .submit-row { display: flex; justify-content: center; align-items: center; gap: 16px; margin-bottom: 18px; flex-wrap: wrap; }
        .user-input-block { margin-bottom: 0; text-align: center; flex: 1 1 300px; }
        .user-input-block input {
            padding: 16px 18px;
            font-size: 20px;
            border-radius: 8px;
            border: 1.5px solid #007bff;
            width: 100%;
            max-width: 350px;
            box-sizing: border-box;
            margin-top: 8px;
            margin-bottom: 4px;
            outline: none;
            transition: border 0.2s;
        }
        .user-input-block input:focus {
            border: 2px solid #0056b3;
        }
        .submit-btn { padding: 16px 32px; font-size: 20px; border: none; border-radius: 8px; background: #007bff; color: #fff; cursor: pointer; transition: background 0.2s, opacity 0.2s; min-width: 120px; }
        .submit-btn:disabled { background: #b0c4de; cursor: not-allowed; opacity: 0.7; }
        .submit-btn:hover:enabled { background: #0056b3; }
        @media (max-width: 900px) { .container { flex-direction: column; align-items: stretch; } .left, .right { max-width: 100%; } .submit-row { flex-direction: column; gap: 8px; } }
        @media (max-width: 600px) { .candidates-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); } .left img, .preview-block img { max-height: 180px; } .user-input-block input { font-size: 16px; padding: 12px 10px; } .submit-btn { font-size: 16px; padding: 12px 18px; } }
        @media (max-width: 768px) {
            nav > div {
                flex-direction: column;
                gap: 10px;
            }
            nav > div > div:last-child {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            font-size: 15px;
            margin-top: 8px;
        }
        .dashboard-table th, .dashboard-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
        }
        .dashboard-table th {
            background: #007bff;
            color: #fff;
            font-weight: 600;
            font-size: 16px;
        }
        .dashboard-table tr:last-child td {
            border-bottom: none;
        }
        .dashboard-table tr:hover {
            background: #f1f7ff;
            transition: background 0.2s;
        }
        .dashboard-table td img {
            max-width: 60px;
            max-height: 60px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .dashboard-table .no-match {
            color: #dc3545;
            font-weight: 600;
            font-style: italic;
        }
        @media (max-width: 700px) {
            .dashboard-table th, .dashboard-table td {
                padding: 6px 4px;
                font-size: 13px;
            }
            .dashboard-table td img {
                max-width: 36px;
                max-height: 36px;
            }
            #user-history-block {
                padding: 8px;
            }
        }
        .dashboard-table-wrapper {
            overflow-x: auto;
            width: 100%;
        }
    </style>
    <script>
        let startTime = Date.now();
        let timerInterval = setInterval(function() {
            let elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('elapsed-time').textContent = elapsed;
        }, 1000);
        function selectCandidate(offerId, imgUrl) {
            document.querySelectorAll('.candidate').forEach(el => el.classList.remove('selected'));
            document.getElementById('candidate-' + offerId).classList.add('selected');
            document.getElementById('selected_offer_id').value = offerId;
            // Hi·ªÉn th·ªã preview l·ªõn
            var preview = document.getElementById('candidate-preview-img');
            preview.src = imgUrl;
            preview.style.display = 'block';
            // Enable submit
            document.getElementById('submit-btn').disabled = false;
        }
        // L∆∞u user v√†o localStorage v√† sessionStorage khi nh·∫≠p
        function saveUserToStorage() {
            var user = document.getElementById('user').value;
            localStorage.setItem('abt_user', user);
            sessionStorage.setItem('abt_user', user);
        }
        function isValidUsername(username) {
            // Ch·ªâ cho ph√©p ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch d∆∞·ªõi, kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng
            return /^[a-zA-Z0-9_]+$/.test(username);
        }
        function checkUserInput() {
            var user = document.getElementById('user').value.trim();
            var accuracyScore = document.getElementById('accuracy_score').value;
            var submitBtn = document.getElementById('submit-btn');
            var skipBtn = document.getElementById('skip-btn');
            if (user && isValidUsername(user) && accuracyScore) {
                submitBtn.disabled = false;
                skipBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
                skipBtn.disabled = true;
            }
        }
        // Khi load trang, t·ª± ƒë·ªông ƒëi·ªÅn user n·∫øu c√≥ (∆∞u ti√™n sessionStorage, fallback localStorage)
        window.onload = function() {
            var user = sessionStorage.getItem('abt_user') || localStorage.getItem('abt_user');
            if (user) document.getElementById('user').value = user;
            checkUserInput();
            var first = document.querySelector('.candidate');
            if (first) first.click();
            // N·∫øu ch∆∞a ch·ªçn candidate th√¨ disable submit
            if (!document.getElementById('selected_offer_id').value) {
                document.getElementById('submit-btn').disabled = true;
            }
        }
        // N·∫øu b·ªè ch·ªçn candidate (reset), disable submit
        function resetCandidateSelection() {
            document.querySelectorAll('.candidate').forEach(el => el.classList.remove('selected'));
            document.getElementById('selected_offer_id').value = '';
            var preview = document.getElementById('candidate-preview-img');
            preview.src = '';
            preview.style.display = 'none';
            document.getElementById('submit-btn').disabled = true;
        }
        function beforeSubmit() {
            let user = document.getElementById('user').value.trim();
            let accuracyScore = document.getElementById('accuracy_score').value;
            if (!isValidUsername(user)) {
                alert('Username ch·ªâ ƒë∆∞·ª£c ph√©p ch·ª©a ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch d∆∞·ªõi, kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng!');
                document.getElementById('user').focus();
                return false;
            }
            if (!accuracyScore) {
                alert('Vui l√≤ng ch·ªçn thang ƒëi·ªÉm ch√≠nh x√°c!');
                document.getElementById('accuracy_score').focus();
                return false;
            }
            let elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('elapsed_time').value = elapsed;
            clearInterval(timerInterval);
            return true;
        }
    </script>
</head>
<body>
    <!-- Navigation Menu -->
    <nav style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 0; margin-bottom: 20px;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
            <div style="color: white; font-size: 20px; font-weight: bold;">
                üè† ABT AI Image Desc
            </div>
            <div style="display: flex; gap: 20px;">
                <a href="/" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">
                    üìä Dashboard
                </a>
                <a href="/image_translation" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">
                    üñºÔ∏è Image Translation
                </a>
                <a href="/analyze_image" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">
                    ü§ñ AI Analysis
                </a>
                <a href="/filter_history" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">
                    üìà History
                </a>
                <a href="/admin" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">
                    ‚öôÔ∏è Admin
                </a>
            </div>
        </div>
    </nav>

    {% if done %}
        <h2 style="text-align:center; margin-top: 48px;">ƒê√£ ho√†n th√†nh t·∫•t c·∫£ d·ªØ li·ªáu c·∫ßn x·ª≠ l√Ω!</h2>
    {% else %}
    <form method="post" action="/submit" onsubmit="return beforeSubmit()">
        <div class="submit-row" style="justify-content:center; align-items:center; width:100%; max-width:600px; margin:0 auto 18px auto;">
            <div class="user-input-block">
                <label for="user" style="font-size:18px; font-weight:600; color:#007bff;">Ng∆∞·ªùi ch·ªçn (username/ƒëi·ªán tho·∫°i):</label><br>
                <input type="text" name="user" id="user" required oninput="saveUserToStorage(); checkUserInput()" autocomplete="username">
            </div>
        </div>

        <div style="text-align:center; margin-bottom:10px; font-size:16px; color:#555;">
            Th·ªùi gian thao t√°c: <span id="elapsed-time">0</span> gi√¢y
        </div>
        <input type="hidden" name="elapsed_time" id="elapsed_time">
        <input type="hidden" name="row_id" value="{{ row_id }}">
        <input type="hidden" name="selected_offer_id" id="selected_offer_id">
        <div class="container">
            <div class="left">
                <h3>·∫¢nh s·∫£n ph·∫©m g·ªëc</h3>
                {% if image_url %}
                    <img src="{{ image_url }}" alt="·∫¢nh g·ªëc">
                {% else %}
                    <p>Kh√¥ng c√≥ ·∫£nh g·ªëc.</p>
                {% endif %}
                {% if abt_label_fields %}
                <div class="label-attrs">
                    <table>
                        <tr><th>Lo·∫°i s·∫£n ph·∫©m</th><td>{{ abt_label_fields.loai_san_pham }}</td></tr>
                        <tr><th>Ch·∫•t li·ªáu</th><td>{{ abt_label_fields.chat_lieu }}</td></tr>
                        <tr><th>V·ªã tr√≠</th><td>{{ abt_label_fields.vi_tri }}</td></tr>
                        <tr><th>M√†u s·∫Øc</th><td>{{ abt_label_fields.mau_sac }}</td></tr>
                        <tr><th>Phong c√°ch</th><td>{{ abt_label_fields.phong_cach_thiet_ke }}</td></tr>
                        <tr><th>Ki·ªÉu d√°ng</th><td>{{ abt_label_fields.kieu_dang }}</td></tr>
                        <tr><th>Ch·ª©c nƒÉng ph·ª•</th><td>{{ abt_label_fields.chuc_nang_phu }}</td></tr>
                        <tr><th>ƒê·∫∑c ƒëi·ªÉm nh·∫≠n d·∫°ng</th><td>{{ abt_label_fields.dac_diem_nhan_dang }}</td></tr>
                        <tr><th>Ch·ªâ s·ªë tin c·∫≠y</th><td>{{ abt_label_fields.chi_so_tin_cay }}</td></tr>
                    </table>
                </div>
                {% endif %}
            </div>
            <div class="right">
                <div class="preview-block">
                    <h3>·∫¢nh candidate ƒë√£ ch·ªçn</h3>
                    <img id="candidate-preview-img" src="" alt="Preview candidate" style="display:none;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3>Ch·ªçn s·∫£n ph·∫©m gi·ªëng nh·∫•t</h3>
                    <a href="/admin" style="padding: 6px 12px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">Admin</a>
                </div>
                <div class="candidates-grid">
                    {% for c in candidates %}
                        {% if c %}
                        <div class="candidate" id="candidate-{{ c.offer_id }}" onclick="selectCandidate('{{ c.offer_id }}', '{{ c.image_url }}')">
                            <img src="{{ c.image_url }}" alt="Candidate {{ loop.index }}"><br>
                            <span>{{ c.subject_trans or c.offer_id }}</span>
                            {% if c.price is not none %}
                                <div style="color:#28a745; font-weight:600; font-size:15px; margin-top:2px;">{{ '%.2f' % c.price }} ÂÖÉ</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div style="margin-top:12px; text-align:right;">
                    <button type="button" onclick="resetCandidateSelection()" style="background:none; border:none; color:#007bff; font-size:15px; cursor:pointer;">B·ªè ch·ªçn ·∫£nh</button>
                </div>
                <div class="submit-row" style="justify-content:center; align-items:center; width:100%; max-width:800px; margin:24px auto 0 auto; gap: 16px;">
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 200px;">
                        <label for="accuracy_score" style="font-size:14px; font-weight:600; color:#007bff; margin-bottom:4px;">Thang ƒëi·ªÉm ch√≠nh x√°c:</label>
                        <select name="accuracy_score" id="accuracy_score" required onchange="checkUserInput()" style="padding: 8px 12px; font-size: 14px; border-radius: 6px; border: 1.5px solid #007bff; width: 180px; box-sizing: border-box; outline: none; transition: border 0.2s;">
                            <option value="">-- Ch·ªçn thang ƒëi·ªÉm --</option>
                            <option value="1">1 - Ch√≠nh x√°c s·∫£n ph·∫©m</option>
                            <option value="2">2 - C√πng s·∫£n ph·∫©m nh∆∞ng kh√°c chi ti·∫øt nh·ªè</option>
                            <option value="3">3 - G·∫ßn gi·ªëng</option>
                            <option value="4">4 - C√πng lo·∫°i s·∫£n ph·∫©m, nh∆∞ng kh√°c m√†u s·∫Øc, ch·∫•t li·ªáu</option>
                            <option value="5">5 - C√πng lo·∫°i s·∫£n ph·∫©m, nh∆∞ng kh√°c bi·ªát</option>
                            <option value="6">6 - Kh√¥ng c√≥ s·∫£n ph·∫©m tr√πng</option>
                        </select>
                    </div>
                    <button type="submit" class="submit-btn" id="submit-btn" disabled>Submit</button>
                    <button type="button" class="submit-btn" id="skip-btn" style="background:#6c757d;" onclick="skipCandidate()" disabled>B·ªè qua</button>
                </div>
            </div>
        </div>
    </form>
    <!-- ƒê∆∞a user-history-block ra ngo√†i form v√† xu·ªëng cu·ªëi trang -->
    <div id="user-history-block" style="max-width:900px; margin:32px auto 0 auto; display:none; background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.04); padding:18px;">
        <div style="font-size:18px; font-weight:600; color:#007bff; margin-bottom:10px;">L·ªãch s·ª≠ l·ªçc c·ªßa b·∫°n</div>
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table" id="user-history-table">
                <thead><tr><th>ID</th><th>·∫¢nh g·ªëc</th><th>·∫¢nh ch·ªçn</th><th>T√™n s·∫£n ph·∫©m</th><th>Thang ƒëi·ªÉm</th><th>Th·ªùi gian thao t√°c (gi√¢y)</th><th>Th·ªùi ƒëi·ªÉm</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    {% endif %}
    <script>
        async function loadUserHistory() {
            var user = sessionStorage.getItem('abt_user') || localStorage.getItem('abt_user');
            if (!user) return;
            let resp = await fetch('/api/filter_history?user=' + encodeURIComponent(user));
            let data = await resp.json();
            if (data.length === 0) return;
            document.getElementById('user-history-block').style.display = '';
            let tbody = document.querySelector('#user-history-table tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                let accuracyScoreText = '';
                if (item.accuracy_score) {
                    const scoreMap = {
                        1: '1 - Ch√≠nh x√°c s·∫£n ph·∫©m',
                        2: '2 - C√πng s·∫£n ph·∫©m nh∆∞ng kh√°c chi ti·∫øt nh·ªè',
                        3: '3 - G·∫ßn gi·ªëng',
                        4: '4 - C√πng lo·∫°i s·∫£n ph·∫©m, nh∆∞ng kh√°c m√†u s·∫Øc, ch·∫•t li·ªáu',
                        5: '5 - C√πng lo·∫°i s·∫£n ph·∫©m, nh∆∞ng kh√°c bi·ªát',
                        6: '6 - Kh√¥ng c√≥ s·∫£n ph·∫©m tr√πng'
                    };
                    accuracyScoreText = scoreMap[item.accuracy_score] || `ƒêi·ªÉm ${item.accuracy_score}`;
                }
                tbody.innerHTML += `<tr>
                    <td>${item.id}</td>
                    <td>${item.image_url ? `<img src='${item.image_url}' loading='lazy'>` : ''}</td>
                    <td>${!item.offer_id ? `<span class='no-match'>Kh√¥ng c√≥ SP tr√πng</span>` : (item.candidate_img ? `<img src='${item.candidate_img}' loading='lazy'>` : '')}</td>
                    <td>${!item.offer_id ? `<span class='no-match'>Kh√¥ng c√≥ SP tr√πng</span>` : (item.subject_trans || '')}</td>
                    <td>${accuracyScoreText}</td>
                    <td>${item.elapsed_time !== null && item.elapsed_time !== undefined ? item.elapsed_time : ''}</td>
                    <td>${item.timestamp ? item.timestamp.replace('T','<br>') : ''}</td>
                    <td><button type='button' onclick='chooseAgain(${item.id})' style='padding:4px 12px; border-radius:6px; background:#007bff; color:#fff; border:none; cursor:pointer;'>Ch·ªçn l·∫°i</button></td>
                </tr>`;
            });
        }
        async function chooseAgain(id) {
            let resp = await fetch('/api/filter_item?id=' + id);
            let item = await resp.json();
            if (!item || item.error) return alert('Kh√¥ng t√¨m th·∫•y item!');
            // C·∫≠p nh·∫≠t giao di·ªán
            document.querySelector('.left img').src = item.image_url;
            document.getElementById('row_id').value = item.id;
            // Render l·∫°i candidates
            let grid = document.querySelector('.candidates-grid');
            grid.innerHTML = '';
            (item.candidates || []).forEach(c => {
                if (!c) return;
                let div = document.createElement('div');
                div.className = 'candidate';
                div.id = 'candidate-' + c.offer_id;
                div.onclick = function() { selectCandidate(c.offer_id, c.image_url); };
                div.innerHTML = `<img src="${c.image_url}" alt="Candidate"><br><span>${c.subject_trans || c.offer_id}</span>` + (c.price !== undefined && c.price !== null ? `<div style='color:#28a745; font-weight:600; font-size:15px; margin-top:2px;'>${parseFloat(c.price).toFixed(2)} ÂÖÉ</div>` : '');
                grid.appendChild(div);
            });
            // Reset preview, selection
            resetCandidateSelection();
            // Set accuracy_score n·∫øu c√≥
            if (item.accuracy_score) {
                document.getElementById('accuracy_score').value = item.accuracy_score;
            }
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang ch·ªânh s·ª≠a
            currentEditId = id;
            document.getElementById('edit-banner').style.display = '';
            document.getElementById('edit-banner-text').textContent = `B·∫°n ƒëang ch·ªânh s·ª≠a l·∫°i item ID: ${id}`;
        }
        function cancelEdit() {
            window.location.href = '/';
        }
        function skipCandidate() {
            var user = document.getElementById('user').value.trim();
            var accuracyScore = document.getElementById('accuracy_score').value;
            if (!isValidUsername(user)) {
                alert('Username ch·ªâ ƒë∆∞·ª£c ph√©p ch·ª©a ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch d∆∞·ªõi, kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng!');
                document.getElementById('user').focus();
                return;
            }
            if (!accuracyScore) {
                alert('Vui l√≤ng ch·ªçn thang ƒëi·ªÉm ch√≠nh x√°c!');
                document.getElementById('accuracy_score').focus();
                return;
            }
            document.getElementById('selected_offer_id').value = '';
            beforeSubmit();
            document.querySelector('form').submit();
        }
        // ƒê·∫£m b·∫£o row_id input c√≥ id ƒë·ªÉ JS c·∫≠p nh·∫≠t
        document.getElementsByName('row_id')[0].id = 'row_id';
        // G·ªçi khi load trang
        loadUserHistory();
    </script>
</body>
</html> 