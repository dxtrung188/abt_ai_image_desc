<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Qu·∫£n l√Ω s·∫£n ph·∫©m ƒë√£ filter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; color: #333; }
        .stats { display: flex; gap: 20px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 10px 15px; border-radius: 6px; }
        .stat-item .number { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-item .label { font-size: 12px; color: #666; }
        
        .filters { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
        .filter-row label { min-width: 120px; font-weight: 600; }
        .filter-row select, .filter-row input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .filter-row button { padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .filter-row button:hover { background: #0056b3; }
        
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .product-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        .product-images { display: flex; gap: 10px; padding: 15px; }
        .product-images img { width: 120px; height: 120px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .product-info { padding: 0 15px 15px 15px; }
        .product-id { font-size: 12px; color: #666; margin-bottom: 5px; }
        .product-subject { font-weight: 600; margin-bottom: 10px; color: #333; }
        .product-details { font-size: 14px; color: #666; margin-bottom: 15px; }
        .product-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-pass { background: #28a745; color: white; }
        .btn-pass:hover { background: #218838; }
        .btn-fail { background: #dc3545; color: white; }
        .btn-fail:hover { background: #c82333; }
        .btn-view { background: #6c757d; color: white; }
        .btn-view:hover { background: #5a6268; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .verification-status { margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .modal-images { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .image-container { text-align: center; }
        .image-container h5 { margin: 0 0 10px 0; color: #333; font-size: 14px; }
        .modal-images img { width: 200px; height: 200px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.2s; }
        .modal-images img:hover { transform: scale(1.05); }
        .candidate-info { margin-top: 10px; font-size: 13px; color: #666; }
        .candidate-info div { margin-bottom: 4px; }
        
        .modal-section { margin-bottom: 20px; }
        .modal-section h4 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .label-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; }
        .label-item { display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .label-key { font-weight: 600; color: #495057; }
        .label-value { color: #666; text-align: right; }
        
        .other-images-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .other-image-item { text-align: center; cursor: pointer; padding: 8px; border-radius: 6px; background: #f8f9fa; transition: background 0.2s; }
        .other-image-item:hover { background: #e9ecef; }
        .other-image-item img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
        .candidate-info-small { text-align: center; }
        .image-id { font-size: 11px; color: #666; display: block; }
        .subject-trans { font-size: 10px; color: #999; display: block; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .modal-details { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .modal-details h4 { margin-top: 0; color: #333; }
        .detail-row { display: flex; margin-bottom: 8px; }
        .detail-label { font-weight: 600; min-width: 150px; color: #495057; }
        .detail-value { color: #666; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        .no-data { text-align: center; padding: 60px 20px; color: #666; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .no-data h3 { margin: 0 0 15px 0; color: #333; }
        .no-data p { margin: 0; font-size: 16px; }
        .filter-notice { background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 20px; }
        .filter-notice h4 { margin: 0 0 10px 0; color: #0056b3; }
        .filter-notice p { margin: 0; color: #333; }
        
        .filtered-summary { 
            background: #fff; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            padding: 20px; 
            display: none; 
        }
        .filtered-summary h3 { margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        .filtered-summary-stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .filtered-stat-item { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            padding: 15px 20px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff;
            min-width: 150px;
        }
        .filtered-stat-item.pending { border-left-color: #ffc107; }
        .filtered-stat-item.pass { border-left-color: #28a745; }
        .filtered-stat-item.fail { border-left-color: #dc3545; }
        .filtered-stat-item .number { font-size: 28px; font-weight: bold; color: #333; }
        .filtered-stat-item .label { font-size: 14px; color: #666; margin-top: 5px; }
        .filtered-stat-item.pending .number { color: #856404; }
        .filtered-stat-item.pass .number { color: #155724; }
        .filtered-stat-item.fail .number { color: #721c24; }
        
        /* Pagination styles */
        .pagination-container {
            background: #fff;
            border-radius: 8px;
            margin: 20px 0;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .pagination-info .showing-info {
            color: #666;
            font-size: 14px;
        }
        .pagination-info .total-info {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.prev, .pagination-btn.next {
            font-weight: bold;
        }
        .page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .page-numbers .pagination-btn {
            min-width: 35px;
        }
        .pagination-ellipsis {
            padding: 8px 4px;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin - Qu·∫£n l√Ω s·∫£n ph·∫©m ƒë√£ filter</h1>
            <div class="stats">
                <div class="stat-item">
                    <div class="number" id="total-count">0</div>
                    <div class="label">T·ªïng s·ªë</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="pass-count">0</div>
                    <div class="label">ƒê·∫°t</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="fail-count">0</div>
                    <div class="label">Kh√¥ng ƒë·∫°t</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="pending-count">0</div>
                    <div class="label">Ch∆∞a verify</div>
                </div>
            </div>
        </div>
        
        <div class="filter-notice">
            <h4>üìã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h4>
            <p>Vui l√≤ng ch·ªçn c√°c b·ªô l·ªçc b√™n d∆∞·ªõi v√† nh·∫•n n√∫t "L·ªçc" ƒë·ªÉ xem d·ªØ li·ªáu. M·∫∑c ƒë·ªãnh trang s·∫Ω kh√¥ng hi·ªÉn th·ªã d·ªØ li·ªáu cho ƒë·∫øn khi b·∫°n th·ª±c hi·ªán l·ªçc.</p>
        </div>
        
        <div class="filters">
            <div class="filter-row">
                <label>Tr·∫°ng th√°i:</label>
                <select id="status-filter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="pass">ƒê·∫°t</option>
                    <option value="fail">Kh√¥ng ƒë·∫°t</option>
                    <option value="pending">Ch∆∞a verify</option>
                </select>
                
                <label>User:</label>
                <select id="user-filter">
                    <option value="">T·∫•t c·∫£</option>
                </select>
                
                <label>T·ª´ ng√†y:</label>
                <input type="date" id="date-from">
                
                <label>ƒê·∫øn ng√†y:</label>
                <input type="date" id="date-to">
                
                <button onclick="loadProducts()">üîç L·ªçc</button>
            </div>
        </div>
        
        <div id="filtered-summary" class="filtered-summary">
            <h3>üìä T√≥m t·∫Øt k·∫øt qu·∫£ l·ªçc</h3>
            <div class="filtered-summary-stats">
                <div class="filtered-stat-item pending">
                    <div class="number" id="filtered-pending-count">0</div>
                    <div class="label">Ch∆∞a verify</div>
                </div>
                <div class="filtered-stat-item pass">
                    <div class="number" id="filtered-pass-count">0</div>
                    <div class="label">ƒê·∫°t</div>
                </div>
                <div class="filtered-stat-item fail">
                    <div class="number" id="filtered-fail-count">0</div>
                    <div class="label">Kh√¥ng ƒë·∫°t</div>
                </div>
                <div class="filtered-stat-item">
                    <div class="number" id="filtered-total-count">0</div>
                    <div class="label">T·ªïng s·ªë</div>
                </div>
            </div>
        </div>
        
        <div id="pagination-container" class="pagination-container">
            <div class="pagination-info">
                <div class="showing-info">
                    Hi·ªÉn th·ªã <span id="showing-start">0</span> - <span id="showing-end">0</span> c·ªßa <span id="showing-total">0</span> k·∫øt qu·∫£
                </div>
                <div class="total-info">
                    Trang <span id="current-page">1</span> / <span id="total-pages">1</span>
                </div>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn prev" onclick="changePage('prev')" disabled>‚Äπ Tr∆∞·ªõc</button>
                <div class="page-numbers" id="page-numbers">
                    <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn next" onclick="changePage('next')" disabled>Ti·∫øp ‚Ä∫</button>
            </div>
        </div>
        
        <div id="products-container">
            <div class="no-data">
                <h3>üìä Ch∆∞a c√≥ d·ªØ li·ªáu ƒë∆∞·ª£c hi·ªÉn th·ªã</h3>
                <p>Vui l√≤ng ch·ªçn c√°c b·ªô l·ªçc v√† nh·∫•n n√∫t "L·ªçc" ƒë·ªÉ xem d·ªØ li·ªáu s·∫£n ph·∫©m ƒë√£ filter.</p>
            </div>
        </div>
        

    </div>
    
    <!-- Modal chi ti·∫øt -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chi ti·∫øt s·∫£n ph·∫©m</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script>
        
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 50;
        let allProducts = [];
        let totalPages = 1;
        
        // Load th·ªëng k√™
        async function loadStats() {
            try {
                let resp = await fetch('/api/admin_stats');
                let data = await resp.json();
                document.getElementById('total-count').textContent = data.total;
                document.getElementById('pass-count').textContent = data.pass;
                document.getElementById('fail-count').textContent = data.fail;
                document.getElementById('pending-count').textContent = data.pending;
            } catch (error) {
                console.error('L·ªói load stats:', error);
            }
        }
        
        // Load danh s√°ch user
        async function loadUsers() {
            try {
                let resp = await fetch('/api/admin_users');
                let users = await resp.json();
                let select = document.getElementById('user-filter');
                users.forEach(user => {
                    let option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('L·ªói load users:', error);
            }
        }
        
        // Load s·∫£n ph·∫©m
        async function loadProducts(page = 1) {
            let container = document.getElementById('products-container');
            container.innerHTML = '<div class="loading">üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</div>';
            
            // Reset pagination
            currentPage = page;
            
            let status = document.getElementById('status-filter').value;
            let user = document.getElementById('user-filter').value;
            let dateFrom = document.getElementById('date-from').value;
            let dateTo = document.getElementById('date-to').value;
            
            try {
                let params = new URLSearchParams({
                    status: status,
                    user: user,
                    date_from: dateFrom,
                    date_to: dateTo
                });
                
                let resp = await fetch(`/api/admin_filtered_products?${params}`);
                let data = await resp.json();
                
                allProducts = data.products || [];
                totalPages = Math.ceil(allProducts.length / itemsPerPage);
                
                renderProducts();
                renderPagination();
            } catch (error) {
                console.error('L·ªói load products:', error);
                container.innerHTML = '<div class="loading">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</div>';
            }
        }
        
        // Render s·∫£n ph·∫©m
        function renderProducts() {
            let container = document.getElementById('products-container');
            let summaryContainer = document.getElementById('filtered-summary');
            let paginationContainer = document.getElementById('pagination-container');
            
            if (allProducts.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>üì≠ Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</h3>
                        <p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc ƒë√£ ch·ªçn. Vui l√≤ng th·ª≠ ƒëi·ªÅu ch·ªânh c√°c b·ªô l·ªçc kh√°c.</p>
                    </div>
                `;
                // Hide summary and pagination when no data
                summaryContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentProducts = allProducts.slice(startIndex, endIndex);
            
            // Calculate summary statistics for all products
            let pendingCount = 0;
            let passCount = 0;
            let failCount = 0;
            
            allProducts.forEach(product => {
                if (!product.verify_result) {
                    pendingCount++;
                } else if (product.verify_result.result === 'pass') {
                    passCount++;
                } else if (product.verify_result.result === 'fail') {
                    failCount++;
                }
            });
            
            // Update and show summary
            document.getElementById('filtered-pending-count').textContent = pendingCount;
            document.getElementById('filtered-pass-count').textContent = passCount;
            document.getElementById('filtered-fail-count').textContent = failCount;
            document.getElementById('filtered-total-count').textContent = allProducts.length;
            summaryContainer.style.display = 'block';
            
            let html = '<div class="products-grid">';
            currentProducts.forEach(product => {
                let statusClass = '';
                let statusText = 'Ch∆∞a verify';
                if (product.verify_result) {
                    if (product.verify_result.result === 'pass') {
                        statusClass = 'status-pass';
                        statusText = 'ƒê·∫°t';
                    } else if (product.verify_result.result === 'fail') {
                        statusClass = 'status-fail';
                        statusText = 'Kh√¥ng ƒë·∫°t';
                    }
                } else {
                    statusClass = 'status-pending';
                }
                
                html += `
                    <div class="product-card" data-product-id="${product.id}">
                        <div class="product-images">
                            <img src="${product.image_url}" alt="·∫¢nh g·ªëc" onclick="showImageModal('${product.image_url}')">
                            ${product.candidate_img ? `<img src="${product.candidate_img}" alt="·∫¢nh candidate" onclick="showImageModal('${product.candidate_img}')">` : ''}
                        </div>
                        <div class="product-info">
                            <div class="product-id">ID: ${product.id}</div>
                            <div class="product-subject">${product.subject_trans || 'Kh√¥ng c√≥ t√™n'}</div>
                            <div class="product-details">
                                User: ${product.user || 'N/A'}<br>
                                Th·ªùi gian: ${product.elapsed_time || 0}s<br>
                                Thang ƒëi·ªÉm: ${getAccuracyScoreText(product.accuracy_score)}<br>
                                Ng√†y: ${product.timestamp ? new Date(product.timestamp).toLocaleDateString('vi-VN') : 'N/A'}
                            </div>
                            <div class="verification-status ${statusClass}">${statusText}</div>
                            <div class="product-actions">
                                <button class="btn btn-view" onclick="viewDetail(${product.id})">Xem chi ti·∫øt</button>
                                ${!product.verify_result ? `
                                    <button class="btn btn-pass" onclick="verifyProduct(${product.id}, 'pass')">ƒê·∫°t</button>
                                    <button class="btn btn-fail" onclick="verifyProduct(${product.id}, 'fail')">Kh√¥ng ƒë·∫°t</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Render pagination controls
        function renderPagination() {
            const paginationContainer = document.getElementById('pagination-container');
            const pageNumbersContainer = document.getElementById('page-numbers');
            
            if (allProducts.length === 0 || totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            
            // Update pagination info
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, allProducts.length);
            
            document.getElementById('showing-start').textContent = startIndex;
            document.getElementById('showing-end').textContent = endIndex;
            document.getElementById('showing-total').textContent = allProducts.length;
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            
            // Update prev/next buttons
            const prevBtn = document.querySelector('.pagination-btn.prev');
            const nextBtn = document.querySelector('.pagination-btn.next');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            // Generate page numbers
            let pageNumbersHtml = '';
            const maxVisiblePages = 7;
            
            if (totalPages <= maxVisiblePages) {
                // Show all pages if total pages <= maxVisiblePages
                for (let i = 1; i <= totalPages; i++) {
                    pageNumbersHtml += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                }
            } else {
                // Show limited pages with ellipsis
                if (currentPage <= 4) {
                    // Show first 5 pages + ellipsis + last page
                    for (let i = 1; i <= 5; i++) {
                        pageNumbersHtml += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    }
                    pageNumbersHtml += '<span class="pagination-ellipsis">...</span>';
                    pageNumbersHtml += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
                } else if (currentPage >= totalPages - 3) {
                    // Show first page + ellipsis + last 5 pages
                    pageNumbersHtml += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                    pageNumbersHtml += '<span class="pagination-ellipsis">...</span>';
                    for (let i = totalPages - 4; i <= totalPages; i++) {
                        pageNumbersHtml += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    }
                } else {
                    // Show first page + ellipsis + current page and neighbors + ellipsis + last page
                    pageNumbersHtml += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                    pageNumbersHtml += '<span class="pagination-ellipsis">...</span>';
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                        pageNumbersHtml += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    }
                    pageNumbersHtml += '<span class="pagination-ellipsis">...</span>';
                    pageNumbersHtml += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
                }
            }
            
            pageNumbersContainer.innerHTML = pageNumbersHtml;
        }
        
        // Change page function
        function changePage(page) {
            if (page === 'prev') {
                page = currentPage - 1;
            } else if (page === 'next') {
                page = currentPage + 1;
            }
            
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                renderProducts();
                renderPagination();
                
                // Scroll to top of products container
                document.getElementById('products-container').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }
        
        // Verify s·∫£n ph·∫©m v·ªõi AJAX
        async function verifyProduct(id, result) {
            try {
                // Disable buttons during verification
                const buttons = document.querySelectorAll(`[onclick*="verifyProduct(${id}"]`);
                buttons.forEach(btn => btn.disabled = true);
                
                let resp = await fetch('/api/admin_verify_product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, result: result })
                });
                
                let data = await resp.json();
                if (data.success) {
                    // Update the specific product card without reloading all
                    updateProductCard(id, result);
                    // Update stats
                    loadStats();
                    // Update filtered summary
                    updateFilteredSummary();
                    // Re-render products to reflect changes
                    renderProducts();
                } else {
                    alert('L·ªói: ' + data.msg);
                    // Re-enable buttons on error
                    buttons.forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                console.error('L·ªói verify:', error);
                alert('L·ªói khi verify s·∫£n ph·∫©m');
                // Re-enable buttons on error
                const buttons = document.querySelectorAll(`[onclick*="verifyProduct(${id}"]`);
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        // Update specific product card after verification
        function updateProductCard(id, result) {
            // Update the product in allProducts array
            const productIndex = allProducts.findIndex(p => p.id === id);
            if (productIndex !== -1) {
                allProducts[productIndex].verify_result = {
                    result: result,
                    timestamp: new Date().toISOString()
                };
            }
            
            // Update the specific product card in DOM
            const productCard = document.querySelector(`[data-product-id="${id}"]`);
            if (!productCard) return;
            
            // Update verification status
            const statusDiv = productCard.querySelector('.verification-status');
            const actionsDiv = productCard.querySelector('.product-actions');
            
            if (result === 'pass') {
                statusDiv.className = 'verification-status status-pass';
                statusDiv.textContent = 'ƒê·∫°t';
            } else {
                statusDiv.className = 'verification-status status-fail';
                statusDiv.textContent = 'Kh√¥ng ƒë·∫°t';
            }
            
            // Remove verify buttons
            const verifyButtons = actionsDiv.querySelectorAll('.btn-pass, .btn-fail');
            verifyButtons.forEach(btn => btn.remove());
        }
        
        // Update filtered summary based on current displayed products
        function updateFilteredSummary() {
            if (allProducts.length === 0) return;
            
            let pendingCount = 0;
            let passCount = 0;
            let failCount = 0;
            
            allProducts.forEach(product => {
                if (!product.verify_result) {
                    pendingCount++;
                } else if (product.verify_result.result === 'pass') {
                    passCount++;
                } else if (product.verify_result.result === 'fail') {
                    failCount++;
                }
            });
            
            // Update summary display
            document.getElementById('filtered-pending-count').textContent = pendingCount;
            document.getElementById('filtered-pass-count').textContent = passCount;
            document.getElementById('filtered-fail-count').textContent = failCount;
            document.getElementById('filtered-total-count').textContent = allProducts.length;
        }
        
        // Xem chi ti·∫øt
        async function viewDetail(id) {
            try {
                let resp = await fetch(`/api/admin_product_detail?id=${id}`);
                let product = await resp.json();
                
                let modalBody = document.getElementById('modal-body');
                let abtLabelHtml = '';
                if (product.abt_label) {
                    let confidenceClass = '';
                    let confidenceValue = 'N/A';
                    if (product.abt_label.chi_so_tin_cay !== null && product.abt_label.chi_so_tin_cay !== undefined) {
                        let conf = parseFloat(product.abt_label.chi_so_tin_cay);
                        if (conf >= 0.7) {
                            confidenceClass = 'confidence-high';
                        } else if (conf >= 0.4) {
                            confidenceClass = 'confidence-medium';
                        } else {
                            confidenceClass = 'confidence-low';
                        }
                        confidenceValue = conf.toFixed(3);
                    }
                    
                    abtLabelHtml = `
                        <div class="modal-section">
                            <h4>Nh√£n AI ph√¢n t√≠ch</h4>
                            <div class="label-grid">
                                <div class="label-item">
                                    <span class="label-key">Lo·∫°i s·∫£n ph·∫©m:</span>
                                    <span class="label-value">${product.abt_label.loai_san_pham || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">Ch·∫•t li·ªáu:</span>
                                    <span class="label-value">${product.abt_label.chat_lieu || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">V·ªã tr√≠:</span>
                                    <span class="label-value">${product.abt_label.vi_tri || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">M√†u s·∫Øc:</span>
                                    <span class="label-value">${product.abt_label.mau_sac || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">Phong c√°ch thi·∫øt k·∫ø:</span>
                                    <span class="label-value">${product.abt_label.phong_cach_thiet_ke || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">Ki·ªÉu d√°ng:</span>
                                    <span class="label-value">${product.abt_label.kieu_dang || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">Ch·ª©c nƒÉng ph·ª•:</span>
                                    <span class="label-value">${product.abt_label.chuc_nang_phu || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">ƒê·∫∑c ƒëi·ªÉm nh·∫≠n d·∫°ng:</span>
                                    <span class="label-value">${product.abt_label.dac_diem_nhan_dang || 'N/A'}</span>
                                </div>
                                <div class="label-item">
                                    <span class="label-key">ƒêi·ªÉm tin c·∫≠y:</span>
                                    <span class="label-value confidence-score ${confidenceClass}">${confidenceValue}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                let otherImagesHtml = '';
                if (product.other_images && Array.isArray(product.other_images) && product.other_images.length > 0) {
                    otherImagesHtml = `
                        <div class="modal-section">
                            <h4>10 s·∫£n ph·∫©m candidate</h4>
                            <div class="other-images-grid">
                                ${product.other_images.map(img => `
                                    <div class="other-image-item" onclick="showImageModal('${img.image_url || ''}')">
                                        <img src="${img.image_url || ''}" alt="·∫¢nh ${img.id || ''}" onerror="this.style.display='none'">
                                        <div class="candidate-info-small">
                                            <span class="image-id">ID: ${img.id || ''}</span>
                                            <span class="subject-trans">${img.subject_trans || ''}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = `
                    <div class="modal-images">
                        <div class="image-container">
                            <h5>·∫¢nh g·ªëc</h5>
                            <img src="${product.image_url}" alt="·∫¢nh g·ªëc" onclick="showImageModal('${product.image_url}')">
                        </div>
                        ${product.candidate_img ? `
                            <div class="image-container">
                                <h5>S·∫£n ph·∫©m ƒë√£ ch·ªçn</h5>
                                <img src="${product.candidate_img}" alt="·∫¢nh candidate" onclick="showImageModal('${product.candidate_img}')">
                                <div class="candidate-info">
                                    <div><strong>T√™n:</strong> ${product.subject_trans || 'N/A'}</div>
                                    ${product.candidate_price ? `<div><strong>Gi√°:</strong> ${product.candidate_price} ÂÖÉ</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-details">
                        <h4>Th√¥ng tin s·∫£n ph·∫©m</h4>
                        <div class="detail-row">
                            <span class="detail-label">ID:</span>
                            <span class="detail-value">${product.id}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">T√™n s·∫£n ph·∫©m:</span>
                            <span class="detail-value">${product.subject_trans || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">User:</span>
                            <span class="detail-value">${product.user || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Th·ªùi gian x·ª≠ l√Ω:</span>
                            <span class="detail-value">${product.elapsed_time || 0}s</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Thang ƒëi·ªÉm:</span>
                            <span class="detail-value">${getAccuracyScoreText(product.accuracy_score)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ng√†y t·∫°o:</span>
                            <span class="detail-value">${product.timestamp ? new Date(product.timestamp).toLocaleString('vi-VN') : 'N/A'}</span>
                        </div>
                        ${product.verify_result ? `
                            <div class="detail-row">
                                <span class="detail-label">K·∫øt qu·∫£ verify:</span>
                                <span class="detail-value">${product.verify_result.result === 'pass' ? 'ƒê·∫°t' : 'Kh√¥ng ƒë·∫°t'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Ng√†y verify:</span>
                                <span class="detail-value">${product.verify_result.timestamp ? new Date(product.verify_result.timestamp).toLocaleString('vi-VN') : 'N/A'}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${abtLabelHtml}
                    ${otherImagesHtml}
                `;
                
                document.getElementById('detail-modal').style.display = 'block';
            } catch (error) {
                console.error('L·ªói load detail:', error);
                alert('L·ªói khi t·∫£i chi ti·∫øt s·∫£n ph·∫©m');
            }
        }
        
        // ƒê√≥ng modal
        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // Modal ·∫£nh
        function showImageModal(imageUrl) {
            let modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
            `;
            modal.innerHTML = `
                <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
            `;
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }
        
        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            let modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Helper function ƒë·ªÉ hi·ªÉn th·ªã text thang ƒëi·ªÉm
        function getAccuracyScoreText(score) {
            if (!score) return 'N/A';
            const scoreMap = {
                1: '1 - Ch√≠nh x√°c s·∫£n ph·∫©m',
                2: '2 - C√πng s·∫£n ph·∫©m nh∆∞ng kh√°c chi ti·∫øt nh·ªè',
                3: '3 - G·∫ßn gi·ªëng',
                4: '4 - C√πng lo·∫°i s·∫£n ph·∫©m, nh∆∞ng kh√°c m√†u s·∫Øc, ch·∫•t li·ªáu',
                5: '5 - C√πng lo·∫°i s·∫£n ph·∫©m, nh∆∞ng kh√°c bi·ªát',
                6: '6 - Kh√¥ng c√≥ s·∫£n ph·∫©m tr√πng'
            };
            return scoreMap[score] || `ƒêi·ªÉm ${score}`;
        }
        
        // Load d·ªØ li·ªáu ban ƒë·∫ßu - ch·ªâ load stats v√† users, kh√¥ng load products
        loadStats();
        loadUsers();
        // Kh√¥ng g·ªçi loadProducts() ·ªü ƒë√¢y n·ªØa
    </script>
</body>
</html> 